<div class="users-page">
  <!-- Header -->
  <div class="page-header-actions">
    <div class="left">
      <h1 class="title">Gestión de Usuarios</h1>
      <p class="subtitle">Administra usuarios y sus permisos</p>
    </div>
    <div class="right">
      @if (isAdminGlobal) {
        <button 
          class="btn btn-primary"
          (click)="openCreateModal()"
        >
          <lucide-icon [img]="UserPlus" [size]="20"></lucide-icon>
          <span>Nuevo Usuario</span>
        </button>
      }
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="flex justify-center items-center py-20">
      <div class="spinner spinner-lg"></div>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="alert alert-danger">
      {{ error() }}
    </div>
  }

  <!-- Content -->
  @if (!loading() && !error()) {
    <!-- Filters -->
    <app-user-filters
      (filterChange)="onFilterChange($event)"
    />

    <!-- Users Grid -->
    @if (filteredUsers().length > 0) {
      <div class="grid-container cols-3 fade-in">
        @for (user of filteredUsers(); track user.usuario_id) {
          <app-user-card 
            [user]="user"
            (edit)="onEditUser($event)"
            (changePermissions)="onChangePermissions($event)"
            (resetPassword)="onResetPassword($event)"
            (deactivate)="onDeactivateUser($event)"
            (activate)="onActivateUser($event)"
          />
        }
      </div>
    } @else {
      <div class="empty-state">
        <div class="icon">
          <lucide-icon [img]="UserPlus" [size]="64" class="text-slate-600"></lucide-icon>
        </div>
        <h3 class="title">No se encontraron usuarios</h3>
        <p class="message">No hay usuarios que coincidan con los filtros aplicados</p>
      </div>
    }
  }
</div>

<!-- Modal Crear Usuario -->
@if (showCreateModal()) {
  <app-user-wizard
    (close)="closeCreateModal()"
    (save)="onSaveUser($event)"
  />
}

<!-- Modal Editar Usuario -->
@if (showEditModal() && selectedUser) {
  <app-user-edit-modal
    [user]="selectedUser"
    (close)="closeEditModal()"
    (saved)="onUserUpdated($event)"
  />
}

<!-- Modal Restablecer Contraseña -->
@if (showResetPasswordModal() && selectedUser) {
  <app-reset-password-modal
    [user]="selectedUser"
    (close)="closeResetPasswordModal()"
  />
}

<!-- Modal Cambiar Permisos -->
@if (showPermissionsModal() && selectedUser) {
  <app-change-permissions-modal
    [user]="selectedUser"
    (close)="closePermissionsModal()"
    (updated)="onPermissionsUpdated()"
  />
}

<!-- Confirm Dialog -->
@if (showConfirmDialog && confirmDialogData) {
  <app-confirm-dialog
    [title]="confirmDialogData.title"
    [message]="confirmDialogData.message"
    [confirmText]="'Aceptar'"
    [cancelText]="'Cancelar'"
    [isLoading]="isConfirmLoading"
    (confirm)="onConfirmDialogConfirm()"
    (cancel)="onConfirmDialogCancel()"
  />
}