<div class="modal-overlay" (click)="onClose()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <div class="flex items-center gap-3">
        <div class="icon-wrapper">
          <lucide-icon [img]="Shield" [size]="24"></lucide-icon>
        </div>
        <div>
          <h2>Gestionar Permisos</h2>
          <p class="text-sm text-slate-400">{{ user.nombre }} {{ user.apellido1 }}</p>
        </div>
      </div>
      <button class="btn btn-ghost btn-icon" (click)="onClose()">
        <lucide-icon [img]="X" [size]="20"></lucide-icon>
      </button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      @if (error) {
        <div class="error-banner">
          <lucide-icon [img]="AlertCircle" [size]="20" class="error-icon"></lucide-icon>
          <span>{{ error }}</span>
        </div>
      }

      @if (isLoading) {
        <div class="text-center py-8">
          <span class="spinner"></span>
          <p class="text-slate-400 mt-2">Cargando permisos...</p>
        </div>
      } @else {
        <!-- Admin Global Badge -->
        @if (user.is_admin_global) {
          <div class="admin-global-badge">
            <lucide-icon [img]="Shield" [size]="20" class="text-purple-400"></lucide-icon>
            <div>
              <p class="font-semibold text-purple-400">Administrador Global</p>
              <p class="text-sm text-slate-400">Este usuario tiene acceso total a todas las granjas del sistema</p>
            </div>
          </div>
        }

        <!-- Granjas asignadas -->
        <div class="section">
          <div class="flex items-center justify-between mb-4">
            <h3 class="section-title">Granjas asignadas ({{ userFarms.length }})</h3>
            @if (availableFarms.length > 0 && !user.is_admin_global) {
              <button 
                class="btn btn-secondary btn-sm"
                (click)="openAssignForm()"
                [disabled]="showAssignForm"
              >
                <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
                <span>Asignar a granja</span>
              </button>
            }
          </div>

          <!-- Formulario de asignación -->
          @if (showAssignForm) {
            <div class="assign-form">
              <div class="form-group">
                <label>Seleccionar granja</label>
                <select 
                  class="form-select"
                  [(ngModel)]="selectedFarmId"
                >
                  @for (farm of availableFarms; track farm.granja_id) {
                    <option [value]="farm.granja_id">{{ farm.nombre }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>Seleccionar rol</label>
                <select 
                  class="form-select"
                  [(ngModel)]="selectedRoleId"
                >
                  @for (role of roles; track role.id) {
                    <option [value]="role.id">{{ role.nombre }}</option>
                  }
                </select>
              </div>

              <div class="flex gap-2 justify-end">
                <button class="btn btn-ghost btn-sm" (click)="cancelAssign()">
                  Cancelar
                </button>
                <button class="btn btn-primary btn-sm" (click)="assignToFarm()">
                  Asignar
                </button>
              </div>
            </div>
          }
          
          @if (userFarms.length === 0 && !user.is_admin_global) {
            <div class="empty-state">
              <lucide-icon [img]="Building2" [size]="48" class="text-slate-600"></lucide-icon>
              <p class="text-slate-400">Este usuario no tiene granjas asignadas</p>
            </div>
          } @else {
            <div class="farms-grid">
              @for (userFarm of userFarms; track userFarm.usuario_granja_id) {
                <div class="farm-permission-card">
                  <div class="card-header">
                    <div class="flex-1">
                      <h4 class="text-white font-semibold">{{ userFarm.granja_nombre }}</h4>
                      
                      <!-- Modo: Vista normal -->
                      @if (editingFarmId !== userFarm.granja_id) {
                        <p class="text-sm text-blue-400 mt-1 flex items-center gap-2">
                          {{ userFarm.rol_nombre }}
                          @if (!user.is_admin_global) {
                            <button 
                              class="btn-edit-role"
                              (click)="startEditRole(userFarm)"
                            >
                              <lucide-icon [img]="Edit" [size]="14"></lucide-icon>
                            </button>
                          }
                        </p>
                      }

                      <!-- Modo: Editar rol -->
                      @if (editingFarmId === userFarm.granja_id) {
                        <div class="edit-role-form">
                          <select 
                            class="form-select form-select-sm"
                            [(ngModel)]="newRoleId"
                          >
                            @for (role of roles; track role.id) {
                              <option [value]="role.id">{{ role.nombre }}</option>
                            }
                          </select>
                          <div class="flex gap-1">
                            <button 
                              class="btn btn-ghost btn-xs"
                              (click)="cancelEditRole()"
                            >
                              Cancelar
                            </button>
                            <button 
                              class="btn btn-primary btn-xs"
                              (click)="saveRoleChange(userFarm.granja_id)"
                            >
                              Guardar
                            </button>
                          </div>
                        </div>
                      }
                      
                      @if (userFarm.scopes.length > 0) {
                        <div class="scopes-list">
                          @for (scope of userFarm.scopes.slice(0, 3); track scope) {
                            <span class="scope-badge">{{ scope }}</span>
                          }
                          @if (userFarm.scopes.length > 3) {
                            <span class="text-xs text-slate-400">+{{ userFarm.scopes.length - 3 }} más</span>
                          }
                        </div>
                      }
                    </div>
                    
                    @if (!user.is_admin_global) {
                      <button 
                        class="btn btn-ghost btn-icon text-red-400"
                        (click)="removeFromFarm(userFarm)"
                      >
                        <lucide-icon [img]="Trash2" [size]="18"></lucide-icon>
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="onClose()">
        Cerrar
      </button>
    </div>
  </div>
</div>