<div class="projection-detail-page">
  @if (loading()) {
    <div class="loading-state">
      <span class="spinner spinner-lg"></span>
      <p class="text-slate-400 mt-4">Cargando detalles...</p>
    </div>
  } @else if (projection()) {
    <!-- Header -->
    <div class="page-header">
      <button class="btn btn-ghost btn-icon" (click)="goBack()">
        <lucide-icon [img]="ArrowLeft" [size]="24"></lucide-icon>
      </button>
      <div class="flex-1">
        <h1 class="title">{{ projection()!.version }}</h1>
        <p class="subtitle">{{ projection()!.descripcion || 'Sin descripción' }}</p>
      </div>
    </div>

    <!-- Info Card -->
    <div class="info-card">
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Estado</span>
          <span class="badge badge-success">
            {{ projection()!.status === 'p' ? 'Publicada' : 'Borrador' }}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">SOB Final Objetivo</span>
          <span class="info-value">{{ projection()!.sob_final_objetivo_pct }}%</span>
        </div>
        <div class="info-item">
          <span class="info-label">Fuente</span>
          <span class="info-value">{{ projection()!.source_ref || 'Manual' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Publicada</span>
          <span class="info-value">
            {{ projection()!.published_at ? (projection()!.published_at | date: 'dd/MM/yyyy HH:mm') : 'No publicada' }}
          </span>
        </div>
      </div>
    </div>

    @if (chartData()) {
      <!-- Gráficos -->
      <div class="charts-grid">
        <!-- SOB Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <lucide-icon [img]="Activity" [size]="20" class="text-blue-400"></lucide-icon>
            <h3 class="chart-title">Sobrevivencia (SOB %)</h3>
          </div>
          <div class="chart-content">
            <div class="simple-chart">
              @for (point of chartData()!.sob; track point.week) {
                <div class="chart-bar">
                  <div 
                    class="bar sob-bar" 
                    [style.height.%]="point.sob"
                    [title]="'Semana ' + point.week + ': ' + point.sob + '%'"
                  ></div>
                  <span class="bar-label">S{{ point.week }}</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- PP Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <lucide-icon [img]="TrendingUp" [size]="20" class="text-green-400"></lucide-icon>
            <h3 class="chart-title">Peso Promedio (g)</h3>
          </div>
          <div class="chart-content">
            <div class="simple-chart">
              @for (point of chartData()!.pp; track point.week) {
                <div class="chart-bar">
                  <div 
                    class="bar pp-bar" 
                    [style.height.%]="(point.pp / (chartData()!.pp[chartData()!.pp.length - 1]?.pp || 1)) * 100"
                    [title]="'Semana ' + point.week + ': ' + point.pp + 'g'"
                  ></div>
                  <span class="bar-label">S{{ point.week }}</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Biomasa Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <lucide-icon [img]="TrendingUp" [size]="20" class="text-purple-400"></lucide-icon>
            <h3 class="chart-title">Biomasa (estimada)</h3>
          </div>
          <div class="chart-content">
            <div class="simple-chart">
              @for (point of chartData()!.biomasa; track point.week) {
                <div class="chart-bar">
                  <div 
                    class="bar biomasa-bar" 
                    [style.height.%]="(point.biomasa / (chartData()!.biomasa[chartData()!.biomasa.length - 1]?.biomasa || 1)) * 100"
                    [title]="'Semana ' + point.week + ': ' + point.biomasa.toFixed(2)"
                  ></div>
                  <span class="bar-label">S{{ point.week }}</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Densidad Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <lucide-icon [img]="Droplets" [size]="20" class="text-cyan-400"></lucide-icon>
            <h3 class="chart-title">Densidad (org/m²)</h3>
          </div>
          <div class="chart-content">
            <div class="simple-chart">
              @for (point of chartData()!.densidad; track point.week) {
                <div class="chart-bar">
                  <div 
                    class="bar densidad-bar"
                    [class.has-harvest]="point.retiro !== null"
                    [style.height.%]="point.densidad"
                    [title]="'Semana ' + point.week + ': ' + point.densidad.toFixed(1) + (point.retiro ? ' (Retiro: ' + point.retiro + ')' : '')"
                  ></div>
                  <span class="bar-label">S{{ point.week }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de líneas -->
      <div class="lines-section">
        <h2 class="section-title">Líneas de Proyección Semanal</h2>
        <div class="table-container">
          <table class="lines-table">
            <thead>
              <tr>
                <th>Semana</th>
                <th>Fecha</th>
                <th>Edad (días)</th>
                <th>PP (g)</th>
                <th>Incremento (g)</th>
                <th>SOB (%)</th>
                <th>Cosecha</th>
                <th>Retiro (org/m²)</th>
              </tr>
            </thead>
            <tbody>
              @for (line of projection()!.lineas; track line.proyeccion_linea_id) {
                <tr [class.harvest-row]="line.cosecha_flag">
                  <td class="font-semibold">{{ line.semana_idx }}</td>
                  <td>{{ line.fecha_plan | date: 'dd/MM/yyyy' }}</td>
                  <td>{{ line.edad_dias }}</td>
                  <td class="text-green-400 font-medium">{{ line.pp_g }}</td>
                  <td class="text-slate-400">{{ line.incremento_g_sem || '-' }}</td>
                  <td class="text-blue-400 font-medium">{{ line.sob_pct_linea }}%</td>
                  <td>
                    @if (line.cosecha_flag) {
                      <span class="badge badge-warning">Cosecha</span>
                    } @else {
                      <span class="text-slate-500">-</span>
                    }
                  </td>
                  <td class="text-red-400 font-medium">
                    {{ line.retiro_org_m2 || '-' }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  } @else if (error()) {
    <div class="error-state">
      <p class="text-red-400">{{ error() }}</p>
      <button class="btn btn-primary mt-4" (click)="goBack()">Volver</button>
    </div>
  }
</div>