<div class="projection-detail-page">
  @if (loading()) {
    <div class="loading-state">
      <span class="spinner spinner-lg"></span>
      <p class="text-slate-400 mt-4">Cargando detalles...</p>
    </div>
  } @else if (projection()) {
    <!-- Header -->
    <div class="page-header">
      <button class="btn btn-ghost btn-icon" (click)="goBack()">
        <lucide-icon [img]="ArrowLeft" [size]="24"></lucide-icon>
      </button>
      <div class="flex-1">
        <h1 class="title">{{ projection()!.version }}</h1>
        <p class="subtitle">{{ projection()!.descripcion || 'Sin descripción' }}</p>
      </div>
    </div>

    <!-- Info Card -->
    <div class="info-card">
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Estado</span>
          <span class="badge badge-success">
            {{ projection()!.status === 'p' ? 'Publicada' : 'Borrador' }}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">SOB Final Objetivo</span>
          <span class="info-value">{{ projection()!.sob_final_objetivo_pct }}%</span>
        </div>
        <div class="info-item">
          <span class="info-label">Fuente</span>
          <span class="info-value">{{ projection()!.source_ref || 'Manual' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Publicada</span>
          <span class="info-value">
            {{ projection()!.published_at ? (projection()!.published_at | date: 'dd/MM/yyyy HH:mm') : 'No publicada' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="charts-grid">
      <!-- Gráfico 1: SOB -->
      <div class="chart-card">
        <h3 class="chart-title">Evolución de Supervivencia (SOB)</h3>
        <p class="chart-subtitle">Porcentaje de supervivencia a lo largo del ciclo</p>
        @if (sobOptions()) {
          <apx-chart
            [series]="sobOptions()!.series!"
            [chart]="sobOptions()!.chart!"
            [xaxis]="sobOptions()!.xaxis!"
            [yaxis]="sobOptions()!.yaxis!"
            [stroke]="sobOptions()!.stroke!"
            [markers]="sobOptions()!.markers!"
            [dataLabels]="sobOptions()!.dataLabels!"
            [grid]="sobOptions()!.grid!"
            [tooltip]="sobOptions()!.tooltip!"
            [colors]="sobOptions()!.colors!"
            [legend]="sobOptions()!.legend!"
          ></apx-chart>
        }
      </div>

      <!-- Gráfico 2: Peso Promedio -->
      <div class="chart-card">
        <h3 class="chart-title">Crecimiento - Peso Promedio</h3>
        <p class="chart-subtitle">Evolución del peso promedio en gramos</p>
        @if (ppOptions()) {
          <apx-chart
            [series]="ppOptions()!.series!"
            [chart]="ppOptions()!.chart!"
            [xaxis]="ppOptions()!.xaxis!"
            [yaxis]="ppOptions()!.yaxis!"
            [stroke]="ppOptions()!.stroke!"
            [markers]="ppOptions()!.markers!"
            [dataLabels]="ppOptions()!.dataLabels!"
            [grid]="ppOptions()!.grid!"
            [tooltip]="ppOptions()!.tooltip!"
            [colors]="ppOptions()!.colors!"
            [legend]="ppOptions()!.legend!"
          ></apx-chart>
        }
      </div>

      <!-- Gráfico 3: Biomasa -->
      <div class="chart-card">
        <h3 class="chart-title">Biomasa Relativa</h3>
        <p class="chart-subtitle">Biomasa estimada (PP × SOB)</p>
        @if (biomasaOptions()) {
          <apx-chart
            [series]="biomasaOptions()!.series!"
            [chart]="biomasaOptions()!.chart!"
            [xaxis]="biomasaOptions()!.xaxis!"
            [yaxis]="biomasaOptions()!.yaxis!"
            [stroke]="biomasaOptions()!.stroke!"
            [markers]="biomasaOptions()!.markers!"
            [dataLabels]="biomasaOptions()!.dataLabels!"
            [grid]="biomasaOptions()!.grid!"
            [tooltip]="biomasaOptions()!.tooltip!"
            [colors]="biomasaOptions()!.colors!"
            [legend]="biomasaOptions()!.legend!"
          ></apx-chart>
        }
      </div>

      <!-- Gráfico 4: Densidad -->
      <div class="chart-card">
        <h3 class="chart-title">Evolución de Densidad</h3>
        <p class="chart-subtitle">Densidad con retiros por cosecha</p>
        @if (densidadOptions()) {
          <apx-chart
            [series]="densidadOptions()!.series!"
            [chart]="densidadOptions()!.chart!"
            [xaxis]="densidadOptions()!.xaxis!"
            [yaxis]="densidadOptions()!.yaxis!"
            [stroke]="densidadOptions()!.stroke!"
            [markers]="densidadOptions()!.markers!"
            [dataLabels]="densidadOptions()!.dataLabels!"
            [grid]="densidadOptions()!.grid!"
            [tooltip]="densidadOptions()!.tooltip!"
            [colors]="densidadOptions()!.colors!"
            [legend]="densidadOptions()!.legend!"
          ></apx-chart>
        }
      </div>
    </div>

    <!-- Tabla de líneas -->
    <div class="lines-section">
      <h2 class="section-title">Líneas de Proyección Semanal</h2>
      <div class="table-container">
        <table class="lines-table">
          <thead>
            <tr>
              <th>Semana</th>
              <th>Fecha</th>
              <th>Edad (días)</th>
              <th>PP (g)</th>
              <th>Incremento (g)</th>
              <th>SOB (%)</th>
              <th>Cosecha</th>
              <th>Retiro (org/m²)</th>
            </tr>
          </thead>
          <tbody>
            @for (line of projection()!.lineas; track line.proyeccion_linea_id) {
              <tr [class.harvest-row]="line.cosecha_flag">
                <td class="font-semibold">{{ line.semana_idx }}</td>
                <td>{{ line.fecha_plan | date: 'dd/MM/yyyy' }}</td>
                <td>{{ line.edad_dias }}</td>
                <td class="text-green-400 font-medium">{{ line.pp_g }}</td>
                <td class="text-slate-400">{{ line.incremento_g_sem || '-' }}</td>
                <td class="text-blue-400 font-medium">{{ line.sob_pct_linea }}%</td>
                <td>
                  @if (line.cosecha_flag) {
                    <span class="badge badge-warning">Cosecha</span>
                  } @else {
                    <span class="text-slate-500">-</span>
                  }
                </td>
                <td class="text-red-400 font-medium">
                  {{ line.retiro_org_m2 || '-' }}
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p class="text-red-400">{{ error() }}</p>
      <button class="btn btn-primary mt-4" (click)="goBack()">Volver</button>
    </div>
  }
</div>